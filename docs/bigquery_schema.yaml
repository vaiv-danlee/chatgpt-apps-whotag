# BigQuery Schema Documentation for LLM Query Generation
# This file is used by the OpenAI API to generate accurate SQL queries

project: mmm-lab

tables:
  # =============================================================================
  # 1. Influencer Profile Analysis Data (Main Reference Table)
  # =============================================================================
  insta_general_profiles:
    dataset: gpt_profile
    full_name: mmm-lab.gpt_profile.insta_general_profiles
    description: |
      AI-analyzed Instagram influencer profiles containing demographic info,
      interests, collaboration readiness, and content characteristics.
      This is the PRIMARY table for filtering influencers by attributes.
    row_count: ~500K
    key_columns:
      - name: user_id
        type: STRING
        description: Unique Instagram user identifier (PRIMARY KEY for joins)
        required: true
      - name: analyzed_at
        type: TIMESTAMP
        description: When the AI analysis was performed
        required: true

    demographic_columns:
      - name: gender
        type: STRING
        description: Inferred gender
        values: ["Male", "Female", "Unknown"]
      - name: age_range
        type: STRING
        description: Estimated age range in 5-year intervals
        values: ["0~4", "5~9", "10~14", "15~19", "20~24", "25~29", "30~34", "35~39", "40~44", "45~49", "50~54", "55~59", "60~64", "65~69", "70+", "Unknown"]
      - name: ethnic_category
        type: STRING
        description: Ethnic/racial category
        values: ["Asian", "East Asian", "Southeast Asian", "South Asian", "Caucasian", "African", "Hispanic/Latino", "Middle Eastern/North African (MENA)", "Pacific Islander", "Indigenous Peoples", "Mixed Race", "Unknown"]
      - name: country
        type: ARRAY<STRING>
        description: Primary residence countries (ISO 3166-1 Alpha-2 codes)
        examples: ["KR", "US", "VN", "JP", "TH", "ID", "PH", "BR"]
      - name: region
        type: ARRAY<STRING>
        description: Primary activity regions/cities
        examples: ["Seoul", "Ho Chi Minh", "Bangkok", "Tokyo"]
      - name: language
        type: ARRAY<STRING>
        description: Languages used (ISO 639-1 codes)
        examples: ["ko", "en", "vi", "ja", "th"]

    interest_columns:
      - name: interests
        type: ARRAY<STRING>
        description: Main interest categories
        values: |
          Fashion & Style, Accessories & Jewelry, Beauty, Hair Care, Food Culture,
          Meals, Beverages, Alcoholic Beverages, Snacks & Desserts, Travel & Leisure,
          Relationships & Emotions, Fitness, Ball Sports, Outdoor Sports, Indoor Sports,
          Sports Events, Wellness, Healthcare, Child Care & Parenting, Pets,
          Household Management, Interior & Decor, Photography, Visual Arts,
          Performing Arts, Music, Literature & Writing, Media & Entertainment,
          New Media, Crafts, Fan Culture, Games, Personal Development, Academic Studies,
          Student Life, Business & Marketing, Startups & Small Business, Personal Finance,
          Automotive, Technology & Innovation, Consumer Electronics, Values & Human Rights,
          Environment & Sustainability, Community Engagement, Religion & Politics,
          Shopping & Deals, Other
      - name: interests_in_detail
        type: ARRAY<STRING>
        description: Detailed interest keywords extracted from content
        examples: ["K Beauty", "Skincare Routine", "Solo Travel", "Cafe Culture"]
      - name: field_of_creator
        type: ARRAY<STRING>
        description: Professional fields for brand collaboration
        examples: ["Sustainable Fashion", "Vegan Cooking", "Travel Photography", "Makeup"]

    business_columns:
      - name: collaboration_tier
        type: STRING
        description: Brand collaboration readiness tier
        values: ["Ready - Premium", "Ready - Professional", "Potential - High", "Potential - Basic", "Personal Only"]
      - name: willing_to_collaborate
        type: BOOLEAN
        description: Explicit willingness to collaborate with brands
      - name: collaborate_brand
        type: ARRAY<STRING>
        description: Brands the influencer has collaborated with
      - name: account_type
        type: STRING
        description: Type of Instagram account
        values: ["Personal/Individual", "Celebrity/Influencer/Creator", "Business/Brand Account", "Product/Service Account", "Fan Account", "Others"]
      - name: k_interest
        type: BOOLEAN
        description: Shows interest in Korean culture (K-pop, K-beauty, etc.)

  # =============================================================================
  # 1-2. Beauty Influencer Profile Analysis Data
  # =============================================================================
  insta_beauty_profiles:
    dataset: gpt_profile
    full_name: mmm-lab.gpt_profile.insta_beauty_profiles
    description: |
      AI-analyzed Instagram beauty influencer profiles containing detailed
      beauty-specific interests, skin/hair analysis, makeup preferences,
      and brand positioning. Use in conjunction with insta_general_profiles.
    row_count: ~500K
    key_columns:
      - name: user_id
        type: STRING
        description: Unique Instagram user identifier (PRIMARY KEY, JOIN with insta_general_profiles)
        required: true
      - name: analyzed_at
        type: TIMESTAMP
        description: When the AI analysis was performed
        required: true

    beauty_interest_columns:
      - name: beauty_interest_areas
        type: ARRAY<STRING>
        description: Detailed beauty interest areas within the beauty field
        examples: ["Skincare", "Makeup", "Hair Care", "Nail Art", "Fragrance"]
      - name: beauty_brands
        type: ARRAY<STRING>
        description: Beauty brands the influencer is interested in or uses
        examples: ["NARS", "MAC", "Innisfree", "Sulwhasoo", "Laneige"]
      - name: beauty_content_types
        type: ARRAY<STRING>
        description: Types of beauty content created
        examples: ["Tutorial", "Review", "GRWM", "Haul", "Before/After"]
      - name: beauty_products
        type: ARRAY<STRING>
        description: Specific beauty product names used
        examples: ["NARS Orgasm Blush", "MAC Ruby Woo", "Sulwhasoo First Care Activating Serum"]

    makeup_columns:
      - name: makeup_interests
        type: ARRAY<STRING>
        description: Makeup-related interests
        examples: ["Natural Makeup", "Bold Lips", "Eye Makeup", "Contouring"]
      - name: makeup_hashtags
        type: ARRAY<STRING>
        description: Makeup-related hashtags used
        examples: ["#dailymakeup", "#kbeauty", "#makeuptutorial"]
      - name: makeup_points
        type: ARRAY<STRING>
        description: Makeup focus points/techniques
        examples: ["Puppy Eyes", "Glass Skin", "Gradient Lips"]
      - name: makeup_items
        type: ARRAY<STRING>
        description: Makeup item categories
        examples: ["Foundation", "Lipstick", "Mascara", "Blush", "Eyeshadow"]
      - name: makeup_color_preferences
        type: ARRAY<STRING>
        description: Color preferences in makeup
        examples: ["Coral", "Nude Pink", "Berry", "Brown Tones"]

    skincare_columns:
      - name: skincare_items
        type: ARRAY<STRING>
        description: Skincare product categories used
        examples: ["Toner", "Serum", "Moisturizer", "Sunscreen", "Essence"]
      - name: skin_concerns
        type: ARRAY<STRING>
        description: Skin concerns
        examples: ["Acne", "Aging", "Dryness", "Sensitivity", "Pigmentation"]
      - name: skin_concerns_in_detail
        type: ARRAY<STRING>
        description: Detailed skin concern descriptions
        examples: ["Hormonal Acne", "Fine Lines Around Eyes", "Redness on Cheeks"]
      - name: skin_type
        type: ARRAY<STRING>
        description: Skin type classification (inferred actively)
        values: ["Oily", "Dry", "Combination", "Normal", "Sensitive"]
      - name: skincare_ingredients
        type: ARRAY<STRING>
        description: Skincare ingredients of interest
        examples: ["Retinol", "Vitamin C", "Hyaluronic Acid", "Niacinamide", "Centella"]

    hair_columns:
      - name: hair_type
        type: STRING
        description: Hair type classification (curl level and thickness)
        values: ["Straight Fine", "Straight Thick", "Wavy", "Curly", "Coily"]
      - name: hair_concerns
        type: ARRAY<STRING>
        description: Hair-related concerns
        examples: ["Frizz", "Damage", "Hair Loss", "Dryness", "Oily Scalp"]
      - name: hair_items
        type: ARRAY<STRING>
        description: Hair care product categories
        examples: ["Shampoo", "Conditioner", "Hair Mask", "Hair Oil", "Heat Protectant"]
      - name: hair_length_status
        type: STRING
        description: Hair length status
        values: ["Short", "Medium", "Long", "Very Long"]
      - name: hair_color_history
        type: ARRAY<STRING>
        description: Hair color history
        examples: ["Black", "Brown", "Blonde", "Red", "Ombre", "Balayage"]

    beauty_tools_columns:
      - name: beauty_tools_categories
        type: ARRAY<STRING>
        description: Beauty tool categories used
        examples: ["Brushes", "Sponges", "LED Devices", "Facial Rollers"]
      - name: beauty_tools_brands
        type: ARRAY<STRING>
        description: Beauty tool brands
        examples: ["Dyson", "FOREO", "Artis", "Real Techniques"]
      - name: beauty_tools_usage
        type: ARRAY<STRING>
        description: How beauty tools are used
        examples: ["Daily Use", "Professional", "Tutorial Featured"]

    personal_color_columns:
      - name: skin_tone
        type: STRING
        description: Skin tone classification
        examples: ["Fair", "Light", "Medium", "Tan", "Deep"]
      - name: personal_color
        type: STRING
        description: Personal color season
        values: ["Spring", "Summer", "Autumn", "Winter"]
      - name: personal_color_detailed
        type: STRING
        description: Detailed personal color subtype
        values: ["Light Spring", "Bright Spring", "True Spring", "Light Summer", "True Summer", "Soft Summer", "Soft Autumn", "True Autumn", "Deep Autumn", "Deep Winter", "True Winter", "Bright Winter"]

    preference_columns:
      - name: aesthetic_keywords
        type: ARRAY<STRING>
        description: Aesthetic preference keywords
        examples: ["Clean Girl", "Y2K", "Coquette", "Minimalist", "Glam"]
      - name: brand_tier_segments
        type: STRING
        description: Brand tier preference
        values: ["Luxury", "Premium", "Mid-Range", "Budget", "Mixed"]
      - name: brand_positioning_segments
        type: STRING
        description: Brand positioning preference
        values: ["Natural/Clean", "Science-Driven", "K-Beauty", "Western", "Indie"]
      - name: purchase_channels
        type: ARRAY<STRING>
        description: Preferred purchase channels
        examples: ["Olive Young", "Sephora", "Online Direct", "Department Store"]
      - name: k_beauty_products
        type: ARRAY<STRING>
        description: K-Beauty product names used
        examples: ["Sulwhasoo First Care", "Laneige Water Bank", "Innisfree Green Tea"]
      - name: beauty_review_focus
        type: ARRAY<STRING>
        description: Focus areas in beauty reviews
        examples: ["Efficacy", "Value", "Packaging", "Texture", "Longevity"]
      - name: beauty_creator_desc
        type: STRING
        description: Comprehensive beauty creator analysis summary (300-500 characters)

  # =============================================================================
  # 1-3. Instagram User External Links
  # =============================================================================
  insta_user_links_v3:
    dataset: sns
    full_name: mmm-lab.sns.insta_user_links_v3
    description: |
      External links associated with Instagram user profiles.
      Contains categorized URLs by type (contact, SNS, shopping) and channel.
      Useful for identifying multi-platform presence and affiliate/shopping links.
    key_columns:
      - name: user_id
        type: STRING
        description: Instagram user ID (JOIN KEY with insta_general_profiles)
        required: true

    link_columns:
      - name: type
        type: STRING
        description: Category type of the link
        values: ["contact", "shopping", "sns"]
      - name: channel
        type: STRING
        description: |
          Platform or channel name.
          SNS: facebook, instagram, linkedin, snapchat, telegram, tiktok, twitter, whatsapp, youtube
          Shopping: amazon, coupang, rakuten, sephora, shopee, shopltk
          Contact: blog, email, kakaotalk
        values: ["amazon", "blog", "coupang", "email", "facebook", "instagram", "kakaotalk", "linkedin", "rakuten", "sephora", "shopee", "shopltk", "snapchat", "telegram", "tiktok", "twitter", "whatsapp", "youtube"]
      - name: urls
        type: ARRAY<STRING>
        description: List of URLs for this channel (use UNNEST to flatten)
        examples: ["https://youtube.com/@username", "https://blog.naver.com/username"]

    metadata_columns:
      - name: updated_at
        type: STRING
        description: Last update timestamp (ISO 8601 format)

  # =============================================================================
  # 2. Instagram Media Posts (Photos/Carousels)
  # =============================================================================
  insta_media_mmm_v3:
    dataset: sns
    full_name: mmm-lab.sns.insta_media_mmm_v3
    description: |
      Instagram feed posts (photos, carousels, videos).
      Contains hashtags, engagement metrics, and post metadata.
      IMPORTANT: For hashtag analysis, use this table along with insta_reels_mmm_v3.
    row_count: ~100M+
    key_columns:
      - name: media_id
        type: STRING
        description: Unique media identifier
      - name: user_id
        type: STRING
        description: Instagram user ID (JOIN KEY with insta_general_profiles)
      - name: username
        type: STRING
        description: Instagram username at time of crawl

    content_columns:
      - name: caption
        type: STRING
        description: Post caption text
      - name: hashtags
        type: ARRAY<STRING>
        description: Hashtags extracted from caption (CRITICAL for trend analysis)
        note: Use UNNEST(hashtags) to flatten for aggregation
      - name: location
        type: STRING
        description: Tagged location name

    engagement_columns:
      - name: like_count
        type: INTEGER
        description: Number of likes
      - name: comment_count
        type: INTEGER
        description: Number of comments
      - name: video_view_count
        type: INTEGER
        description: Video views (legacy field, for videos only)
      - name: video_play_count
        type: INTEGER
        description: Video plays (newer field, for videos only)

    metadata_columns:
      - name: publish_date
        type: TIMESTAMP
        description: Post publish timestamp (KST timezone)
      - name: publish_short_date
        type: STRING
        description: Publish date as YYYYMMDD string
      - name: is_video
        type: BOOLEAN
        description: Whether the post is a video
      - name: is_paid_partnership
        type: BOOLEAN
        description: Whether marked as paid partnership/sponsored
      - name: sponsored_by
        type: STRING
        description: Sponsor usernames (comma-separated)
      - name: tagged_accounts
        type: ARRAY<STRING>
        description: Tagged account usernames
      - name: crawl_date
        type: TIMESTAMP
        description: When data was collected

  # =============================================================================
  # 3. Instagram Reels
  # =============================================================================
  insta_reels_mmm_v3:
    dataset: sns
    full_name: mmm-lab.sns.insta_reels_mmm_v3
    description: |
      Instagram Reels (short-form video content).
      Structure similar to media table but with reel-specific fields.
      IMPORTANT: Combine with insta_media_mmm_v3 for complete hashtag analysis.
    row_count: ~50M+
    key_columns:
      - name: media_id
        type: STRING
        description: Unique reel identifier
      - name: user_id
        type: STRING
        description: Instagram user ID (JOIN KEY)
      - name: username
        type: STRING
        description: Instagram username

    content_columns:
      - name: caption
        type: STRING
        description: Reel caption text
      - name: hashtags
        type: ARRAY<STRING>
        description: Hashtags from caption (CRITICAL for trend analysis)
      - name: location
        type: STRING
        description: Tagged location
      - name: video_duration
        type: FLOAT
        description: Video duration in seconds

    engagement_columns:
      - name: like_count
        type: INTEGER
        description: Number of likes
      - name: comment_count
        type: INTEGER
        description: Number of comments
      - name: video_play_count
        type: INTEGER
        description: Video play count (primary metric for reels)
      - name: video_view_count
        type: INTEGER
        description: Video view count (legacy)

    metadata_columns:
      - name: publish_date
        type: TIMESTAMP
        description: Reel publish timestamp (KST)
      - name: publish_short_date
        type: STRING
        description: Publish date as YYYYMMDD
      - name: is_paid_partnership
        type: BOOLEAN
        description: Paid partnership indicator
      - name: sponsored_by
        type: STRING
        description: Sponsor usernames

  # =============================================================================
  # 4. Instagram Profile Data
  # =============================================================================
  insta_profile_mmm_v3:
    dataset: sns
    full_name: mmm-lab.sns.insta_profile_mmm_v3
    description: |
      Basic Instagram profile information.
      WARNING: Large table - always JOIN with insta_general_profiles.user_id first!
    row_count: ~10M+
    usage_note: |
      Due to large size, ALWAYS filter by user_id from insta_general_profiles first.
      Example: JOIN with (SELECT user_id FROM insta_general_profiles WHERE country = 'VN')
    key_columns:
      - name: user_id
        type: STRING
        description: Instagram user ID (JOIN KEY)
      - name: username
        type: STRING
        description: Instagram username

    profile_columns:
      - name: full_name
        type: STRING
        description: Display name
      - name: biography
        type: STRING
        description: Profile bio text
      - name: bio_hashtags
        type: ARRAY<STRING>
        description: Hashtags in biography
      - name: followed_by
        type: INTEGER
        description: Follower count
      - name: follows
        type: INTEGER
        description: Following count
      - name: media_count
        type: INTEGER
        description: Total posts count
      - name: profile_pic_url
        type: STRING
        description: Profile picture URL
      - name: external_url
        type: STRING
        description: Website link in bio
      - name: category_name
        type: STRING
        description: Instagram business category
      - name: is_verified
        type: BOOLEAN
        description: Blue checkmark status
      - name: is_business_account
        type: BOOLEAN
        description: Business account flag
      - name: is_professional_account
        type: BOOLEAN
        description: Professional account flag

# =============================================================================
# Common Query Patterns
# =============================================================================
query_patterns:
  hashtag_trend_analysis:
    description: Analyze hashtag trends for specific influencer groups
    pattern: |
      -- Step 1: Filter influencers by criteria
      WITH target_influencers AS (
        SELECT user_id
        FROM `mmm-lab.gpt_profile.insta_general_profiles`
        WHERE 'VN' IN UNNEST(country)  -- Example: Vietnam
          AND 'Beauty' IN UNNEST(interests)
      ),
      -- Step 2: Get hashtags from both media and reels
      all_hashtags AS (
        SELECT hashtag, publish_date
        FROM `mmm-lab.sns.insta_media_mmm_v3`, UNNEST(hashtags) AS hashtag
        WHERE user_id IN (SELECT user_id FROM target_influencers)
          AND publish_date >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 DAY)
        UNION ALL
        SELECT hashtag, publish_date
        FROM `mmm-lab.sns.insta_reels_mmm_v3`, UNNEST(hashtags) AS hashtag
        WHERE user_id IN (SELECT user_id FROM target_influencers)
          AND publish_date >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 DAY)
      )
      -- Step 3: Aggregate
      SELECT
        LOWER(hashtag) as hashtag,
        COUNT(*) as usage_count
      FROM all_hashtags
      GROUP BY 1
      ORDER BY 2 DESC
      LIMIT 100

  content_statistics:
    description: Get engagement statistics for influencer groups
    pattern: |
      WITH target_influencers AS (
        SELECT user_id
        FROM `mmm-lab.gpt_profile.insta_general_profiles`
        WHERE 'KR' IN UNNEST(country)
          AND 'Fashion & Style' IN UNNEST(interests)
      )
      SELECT
        COUNT(DISTINCT m.user_id) as influencer_count,
        COUNT(*) as total_posts,
        AVG(like_count) as avg_likes,
        AVG(comment_count) as avg_comments,
        PERCENTILE_CONT(like_count, 0.5) OVER() as median_likes
      FROM `mmm-lab.sns.insta_media_mmm_v3` m
      WHERE m.user_id IN (SELECT user_id FROM target_influencers)
        AND publish_date >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 DAY)

# =============================================================================
# Important Notes for Query Generation
# =============================================================================
important_notes:
  - Always use backticks for table names: `mmm-lab.dataset.table`
  - Use UNNEST() to work with ARRAY columns
  - Filter by date using publish_date column with TIMESTAMP functions
  - For hashtag analysis, ALWAYS combine insta_media_mmm_v3 AND insta_reels_mmm_v3
  - Country codes are ISO 3166-1 Alpha-2 (KR, US, VN, JP, TH, ID, etc.)
  - Language codes are ISO 639-1 (ko, en, vi, ja, th, etc.)
  - When querying insta_profile_mmm_v3, ALWAYS join with insta_general_profiles first
  - Use LOWER() for case-insensitive hashtag comparison
  - Timezone is KST (Korea Standard Time, UTC+9)
